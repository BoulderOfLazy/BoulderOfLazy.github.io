const translations = {
    ru: {
        title: "Ультимативный \"Любимая игра meme\"",
        h1: "УЛЬТИМАТИВНЫЙ \"ЛЮБИМАЯ ИГРА MEME\"",
        placeholder: "Нажми, чтобы вставить изображение",
        pasteAlert: "Теперь вставьте изображение из буфера обмена (Ctrl+V или Command+V)",
        noImageAlert: "В буфере обмена нет изображения. Убедитесь, что вы скопировали изображение.",
        screenshotButton: "Генерировать скриншот",
        downloadButton: "Скачать как HTML",
        clearButton: "Очистить",
        toggleLeft: "Я здесь чисто изображения вставить",
        toggleRight: "Хочу также написать комментарии",
        clearConfirm: "Вы уверены, что хотите очистить все изображения и текст?",
        langButton: "EN",
        commentButton: "Комментарий",
        shareTitle: "Ссылка для общего доступа",
        shareDesc: "Отправьте эту ссылку, чтобы другие могли просмотреть вашу версию:",
        copyLink: "Скопировать ссылку",
        linkCopied: "Ссылка скопирована!",
        generatingShare: "Подготовка ссылки...",
        shareError: "Ошибка при создании ссылки",
        modalTitle: "Комментарий",
        commentPlaceholder: "Введите ваш комментарий...",
        infoTrigger: "В чём отличие?",
        infoTitle: "\"Генерировать скриншот\" vs \"Скачать как HTML\"",
        infoText: "<b>Генерировать скриншот:</b> Создает обычную картинку (JPG). Идеально для быстрой отправки в соцсети или друзьям. Комментарии при этом не будут показаны<br><br><b>Скачать как HTML:</b> Скачивает интерактивный файл. В нём сохраняются все ваши комментарии. Если открыть этот файл в браузере, вы (или другие) сможете прочитать написанное.",
        infoClose: "Понятно",
        filenamePlaceholder: "Имя файла...",
        saveBtn: "Сохранить",
        phrases: [
            "Игра, которую должен пройти каждый", "Лучшая история", "Любимый визуальный стиль", "Заставляет задуматься", "\"Я тебя закончу, когда-нибудь..\"", "Любимая серия игр", "Лучшая боёвка", "Хорошая игра с плохим комьюнити", "Фанатская игра для фанатов от фанатов", "Игра с наибольшим наигранным временем",
            "200iq стратегия", "Ты любишь, но все ненавидят", "Ты ненавидишь, но всем нравится", "Недооценено", "Переоценено", "Годная инди", "Годная ААА", "Мясо, матюки, убийства...", "Лучшая детская игра", "Когда сиквел лучше оригинала",
            "Годнота отечественных разрабов", "ОМГ эта атмосфера", "Любимый антагонист", "Любимый протагонист", "Любимый второстепенный персонаж", "Упущенный потенциал", "Наибольшее разочарование", "Ремейк/ремастер, который смог", "Вот раньше были игры...", "Друг познаётся в коопе",
            "Ночной кошмар казуальщика", "Игра не для всех", "Любимый симулятор", "Депрессивная игра", "Лучший саундтрек", "\"Почему мне это нравится?\"", "Всегда возвращаешься", "Любимая бесплатная игра", "Нелюбимая игра от любимого разрабочика", "Любимая игра от нелюбимого издателя",
            "Лучший шутер", "Лучший юмор", "Лучший мультиплеер", "Лучший хоррор", "Лучший рогалик", "Лучший выживач/песочница", "Самая первая игра, в которую ты играл", "Самая ожидаемая игра", "Любимая игра для мобилки", "Лучшая концовка"
        ]
    },
    en: {
        title: "The Ultimate \"Favorite Game Meme\"",
        h1: "THE ULTIMATE \"FAVORITE GAME MEME\"",
        placeholder: "Click to paste an image",
        pasteAlert: "Now paste an image from your clipboard (Ctrl+V or Command+V)",
        noImageAlert: "No image found on clipboard. Make sure you copied an image.",
        screenshotButton: "Generate Screenshot",
        downloadButton: "Download as HTML",
        clearButton: "Clear",
        toggleLeft: "I'm only here to paste images",
        toggleRight: "I also want to comment on some/all categories",
        clearConfirm: "Are you sure you want to clear all images and text?",
        langButton: "RU",
        commentButton: "Comment",
        shareTitle: "Share Link",
        shareDesc: "Send this link so others can view your version:",
        copyLink: "Copy Link",
        linkCopied: "Link copied!",
        generatingShare: "Preparing link...",
        shareError: "Error creating link",
        modalTitle: "Comment",
        commentPlaceholder: "Enter your comment...",
        infoTrigger: "What's the difference?",
        infoTitle: "\"Generate screenshot\" vs \"Download as HTML\"",
        infoText: "<b>Generate screenshot:</b> Generates a standard image (JPG). Perfect for quickly sharing on social media. Commentaries won't be shown.<br><br><b>Download as HTML:</b> Downloads an interactive file. It preserves all your comments. You (or others) can open this file in a browser to read what you wrote.",
        infoClose: "Got it",
        filenamePlaceholder: "Filename...",
        saveBtn: "Save",
        phrases: [
            "A game everyone should play", "Best story", "Favorite visual style", "Makes you think", "\"I'll finish you... someday\"", "Favorite game series", "Best combat", "Good game, bad community", "A fan game for fans by fans", "Most played game",
            "200iq strategy", "You love it, everyone hates it", "You hate it, everyone loves it", "Underrated", "Overrated", "Great indie", "Great AAA", "Gore, swearing, violence...", "Best kids' game", "When the sequel is better",
            "Great local dev game", "OMG this atmosphere", "Favorite antagonist", "Favorite protagonist", "Favorite side character", "Wasted potential", "Biggest disappointment", "A remake/remaster that delivered", "They don't make 'em like they used to", "A friend is tested in co-op",
            "A casual's nightmare", "Not for everyone", "Favorite simulator", "Depressing game", "Best soundtrack", "\"Why do I like this?\"", "You always come back to", "Favorite free-to-play", "Disliked game from a fav developer", "Favorite game from a disliked publisher",
            "Best shooter", "Best humor", "Best multiplayer", "Best horror", "Best roguelike", "Best survival/sandbox", "The very first game you played", "Most anticipated game", "Favorite mobile game", "Best ending"
        ]
    }
};

const icons = {
    screenshot: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm40-80h480L570-480 450-320l-90-120-120 160Zm-40 80v-560 560Z"/></svg>',
    download: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M320-240 80-480l240-240 57 57-184 184 183 183-56 56Zm320 0-57-57 184-184-183-183 56-56 240 240-240 240Z"/></svg>',
    clear: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/></svg>',
    lang: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3"><path d="M480-80q-82 0-155-31.5t-127.5-86Q143-252 111.5-325T80-480q0-83 31.5-155.5t86-127Q252-817 325-848.5T480-880q83 0 155.5 31.5t127 86q54.5 54.5 86 127T880-480q0 82-31.5 155t-86 127.5q-54.5 54.5-127 86T480-80Zm0-82q26-36 45-75t31-83H404q12 44 31 83t45 75Zm-104-16q-18-33-31.5-68.5T322-320H204q29 50 72.5 87t99.5 55Zm208 0q56-18 99.5-55t72.5-87H638q-9 38-22.5 73.5T584-178ZM170-400h136q-3-20-4.5-39.5T300-480q0-21 1.5-40.5T306-560H170q-5 20-7.5 39.5T160-480q0 21 2.5 40.5T170-400Zm216 0h188q3-20 4.5-39.5T580-480q0-21-1.5-40.5T574-560H386q-3 20-4.5 39.5T380-480q0 21 1.5 40.5T386-400Zm268 0h136q5-20 7.5-39.5T800-480q0-21-2.5-40.5T790-560H654q3 20 4.5 39.5T660-480q0 21-1.5 40.5T654-400Zm-16-240h118q-29-50-72.5-87T584-782q18 33 31.5 68.5T638-640Zm-234 0h152q-12-44-31-83t-45-75q-26 36-45 75t-31 83Zm-200 0h118q9-38 22.5-73.5T376-782q-56 18-99.5 55T204-640Z"/></svg>',
    save: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M840-680v480q0 33-23.5 56.5T760-120H200q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h480l160 160Zm-80 34L646-760H200v560h560v-446ZM480-240q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35ZM240-560h360v-160H240v160Zm-40-86v446-560 114Z"/></svg>',
    cancel: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>',
    check: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z"/></svg>',
    themeLight: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Z"/></svg>',
    themeDark: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M480-280q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM200-440H40v-80h160v80Zm720 0H760v-80h160v80ZM440-760v-160h80v160h-80Zm0 720v-160h80v160h-80ZM256-650l-101-97 57-59 96 100-52 56Zm492 496-97-101 53-55 101 97-57 59Zm-98-550 97-101 59 57-100 96-56-52ZM154-218l101-97 55 53-97 101-59-57Z"/></svg>'
};

const OverTypeLightTheme = {
    name: 'custom-light',
    colors: {
        bgPrimary: '#ffffff',    
        bgSecondary: '#ffffff',  
        text: '#202020',         
        border: '#ccc',          
        cursor: '#202020',
        selection: 'rgba(100, 100, 100, 0.4)',
        syntaxMarker: '#474747ff',
        link: '#0066cc',
        code: '#202020',
        codeBg: '#eee'
    }
};

const OverTypeDarkTheme = {
    name: 'custom-dark',
    colors: {
        bgPrimary: '#121212',    
        bgSecondary: '#121212',
        text: '#e0e0e0',         
        border: '#444',          
        cursor: '#e0e0e0',
        selection: 'rgba(212, 212, 212, 0.4)',
        syntaxMarker: '#b4b4b4ff',
        link: '#66b3ff',
        code: '#e0e0e0',
        codeBg: '#2a2a2a'
    }
};

let currentLang = 'ru';
let currentPlaceholder = null;
let currentCommentIndex = null;
let onFilenameConfirmed = null;
let db;
const grid = document.querySelector('.grid');
let isViewMode = false;
let pendingExportType = null;
const filenameModal = document.getElementById('filename-modal');
const filenameInput = document.getElementById('filename-input');
const filenameSaveBtn = document.getElementById('filename-save-btn');
function initDB(callback) {
    const request = indexedDB.open('imageMemeDB', 3);
    request.onerror = (event) => console.error("Database error: " + event.target.errorCode);
    request.onsuccess = (event) => {
        db = event.target.result;
        callback();
    };
    request.onupgradeneeded = (event) => {
        const db = event.target.result;
        const oldVersion = event.oldVersion;
        if (oldVersion < 1) {
            db.createObjectStore('images', { keyPath: 'id' });
        }
        if (oldVersion < 2) {
            db.createObjectStore('customTexts', { keyPath: 'id' });
        }
        if (oldVersion < 3) {
            db.createObjectStore('comments', { keyPath: 'id' });
        }
    };
}

const saveImage = (index, imageData) => {
    if (!db) return;
    const transaction = db.transaction(['images'], 'readwrite');
    const objectStore = transaction.objectStore('images');
    objectStore.put({ id: index, image: imageData });
};

const loadImages = () => {
    if (!db) return;
    const transaction = db.transaction(['images'], 'readonly');
    const objectStore = transaction.objectStore('images');
    const placeholders = document.querySelectorAll('.image-placeholder');

    objectStore.getAll().onsuccess = (event) => {
        const images = event.target.result;
        images.forEach(item => {
            if (placeholders[item.id]) {
                let imageUrl;
                if (item.image instanceof Blob) {
                    imageUrl = URL.createObjectURL(item.image);
                } else {
                    imageUrl = item.image;
                }
                
                placeholders[item.id].style.backgroundImage = `url(${imageUrl})`;
                placeholders[item.id].innerText = '';
            }
        });
    };
};

const saveText = (index, text) => {
    if (!db) return;
    const id = `${currentLang}_${index}`;
    const transaction = db.transaction(['customTexts'], 'readwrite');
    const objectStore = transaction.objectStore('customTexts');
    objectStore.put({ id: id, text: text });
};

const loadTexts = () => {
    if (!db) return;
    const transaction = db.transaction(['customTexts'], 'readonly');
    const objectStore = transaction.objectStore('customTexts');
    const textElements = document.querySelectorAll('.card p');

    objectStore.getAll().onsuccess = (event) => {
        const allTexts = event.target.result;
        allTexts.forEach(item => {
            const [lang, indexStr] = item.id.split('_');
            if (lang === currentLang) {
                const index = parseInt(indexStr);
                if (textElements[index]) {
                    textElements[index].innerText = item.text;
                }
            }
        });
    };
};

const saveComment = (index, comment) => {
    if (!db) return;
    const id = `${currentLang}_comment_${index}`;
    const transaction = db.transaction(['comments'], 'readwrite');
    const objectStore = transaction.objectStore('comments');
    objectStore.put({ id: id, comment: comment });
};

const loadComments = () => {
    if (!db) return;
    const transaction = db.transaction(['comments'], 'readonly');
    const objectStore = transaction.objectStore('comments');

    objectStore.getAll().onsuccess = (event) => {
        const allComments = event.target.result;
        allComments.forEach(item => {
            const [lang, type, indexStr] = item.id.split('_');
            if (lang === currentLang && type === 'comment') {
                const index = parseInt(indexStr);
                const btn = document.querySelector(`[data-comment-index="${index}"]`);
                if (btn) {
                    btn.setAttribute('data-has-comment', item.comment ? 'true' : 'false');
                }
            }
        });
    };
};

const getComment = (index, callback) => {
    if (!db) {
        callback('');
        return;
    }
    const id = `${currentLang}_comment_${index}`;
    const transaction = db.transaction(['comments'], 'readonly');
    const objectStore = transaction.objectStore('comments');
    const request = objectStore.get(id);

    request.onsuccess = (event) => {
        const result = event.target.result;
        callback(result ? result.comment : '');
    };
};

document.addEventListener('paste', (event) => {
    if (!currentPlaceholder) return;

    const items = event.clipboardData.items;
    let imageFound = false;
    
    for (let item of items) {
        if (item.type.startsWith('image/')) {
            imageFound = true;
            const blob = item.getAsFile();
            const reader = new FileReader();
            
            reader.onload = (e) => {
                processImage(e.target.result, (compressedBase64) => {
                    const placeholderIndex = parseInt(currentPlaceholder.dataset.index);
                    
                    saveImage(placeholderIndex, compressedBase64);
                    
                    currentPlaceholder.style.backgroundImage = `url(${compressedBase64})`;
                    currentPlaceholder.innerText = '';
                    currentPlaceholder = null;
                });
            };
            reader.readAsDataURL(blob);
            break;
        }
    }
    
    if (!imageFound) {
        alert(translations[currentLang].noImageAlert);
    }
});

function processImage(base64Str, callback) {
    const img = new Image();
    img.onload = () => {
        const canvas = document.createElement('canvas');
        const targetWidth = 264;
        const targetHeight = 352;
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        const ctx = canvas.getContext('2d');

        const scale = Math.max(targetWidth / img.width, targetHeight / img.height);
        
        const newWidth = img.width * scale;
        const newHeight = img.height * scale;
        
        const x = (targetWidth - newWidth) / 2;
        const y = (targetHeight - newHeight) / 2;

        ctx.drawImage(img, x, y, newWidth, newHeight);
        
        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
        callback(compressedDataUrl);
    };
    img.src = base64Str;
}

function generateGrid(lang) {
    grid.innerHTML = '';
    const t = translations[lang];

    t.phrases.forEach((phrase, index) => {
        const card = document.createElement('div');
        card.className = 'card';
        const placeholder = document.createElement('div');
        placeholder.className = 'image-placeholder';
        placeholder.innerText = t.placeholder;
        placeholder.dataset.index = index;

        if (!isViewMode) {
            placeholder.addEventListener('click', (event) => {
                currentPlaceholder = event.target;
                alert(translations[currentLang].pasteAlert);
            });
        }

        const text = document.createElement('p');
        text.contentEditable = !isViewMode;
        text.innerText = phrase;

        if (!isViewMode) {
            text.addEventListener('blur', (event) => {
                saveText(index, event.target.innerText);
            });
        }

        const btn = document.createElement('button');
        btn.className = 'comment-btn';
        btn.dataset.commentIndex = index;
        btn.innerHTML = `<span style="font-size:16px"><svg xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="#000000"><path d="M240-400h480v-80H240v80Zm0-120h480v-80H240v80Zm0-120h480v-80H240v80ZM880-80 720-240H160q-33 0-56.5-23.5T80-320v-480q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v720ZM160-320h594l46 45v-525H160v480Zm0 0v-480 480Z"/></svg></span><span>${t.commentButton}</span>`;

        btn.addEventListener('click', (e) => {
            currentCommentIndex = index;
            showPanel(index, e.currentTarget);
        });

        card.appendChild(placeholder);
        card.appendChild(text);
        card.appendChild(btn);
        grid.appendChild(card);
    });

    loadImages();
    loadComments();
}

function showModal() {
    const modal = document.getElementById('modal');
    const overlay = document.getElementById('overlay');
    overlay.style.display = 'block';
    modal.style.display = 'block';
    requestAnimationFrame(() => {
        modal.classList.add('open');
    });
}

function updateUI(lang) {
    const t = translations[lang];
    document.documentElement.lang = lang;
    document.title = t.title;
    document.querySelector('h1').innerText = t.h1;

    document.getElementById('screenshot').innerHTML = `${icons.screenshot}<span>${t.screenshotButton}</span>`;
    document.getElementById('download-btn').innerHTML = `${icons.download}<span>${t.downloadButton}</span>`;
    document.getElementById('clear').innerHTML = `${icons.clear}<span>${t.clearButton}</span>`;
    document.getElementById('lang-toggle').innerHTML = `${icons.lang}<span>${t.langButton}</span>`;

    document.getElementById('toggle-left').innerText = t.toggleLeft;
    document.getElementById('toggle-right').innerText = t.toggleRight;

    document.getElementById('modal-title').innerText = t.modalTitle;

    document.getElementById('info-trigger').innerText = t.infoTrigger;
    document.getElementById('info-modal-title').innerText = t.infoTitle;
    document.getElementById('info-modal-text').innerHTML = t.infoText;

    document.getElementById('info-modal-close').innerHTML = `${icons.check}<span>${t.infoClose}</span>`;

    document.getElementById('filename-input').placeholder = t.filenamePlaceholder;
    document.getElementById('filename-save-btn').innerHTML = `${icons.save}<span>${t.saveBtn}</span>`;

    generateGrid(lang);

    const isEnabled = document.getElementById('comment-toggle').checked;
    const downloadBtn = document.getElementById('download-btn');
    const commentBtns = document.querySelectorAll('.comment-btn');
    const infoLink = document.querySelector('.info-link-container');

    if (isEnabled) {
        downloadBtn.style.display = 'inline-flex';
        commentBtns.forEach(btn => btn.style.display = 'flex');
        if (infoLink) infoLink.style.display = 'block';
    } else {
        downloadBtn.style.display = 'none';
        commentBtns.forEach(btn => btn.style.display = 'none');
        if (infoLink) infoLink.style.display = 'none';
    }
}

function getAllData(callback) {
    if (!db) {
        callback({ images: {}, texts: {}, comments: {} });
        return;
    }

    const data = { images: {}, texts: {}, comments: {} };
    let imagesProcessed = 0;
    let imagesToProcess = 0;

    const imgTransaction = db.transaction(['images'], 'readonly');
    imgTransaction.objectStore('images').getAll().onsuccess = (event) => {
        const images = event.target.result;
        let processedCount = 0;

        if (images.length === 0) {
            loadTextsAndComments();
            return;
        }

        images.forEach(item => {
            if (typeof item.image === 'string') {
                data.images[item.id] = item.image;
                processedCount++;
                if (processedCount === images.length) loadTextsAndComments();
            } else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    data.images[item.id] = e.target.result;
                    processedCount++;
                    if (processedCount === images.length) loadTextsAndComments();
                };
                reader.readAsDataURL(item.image);
            }
        });
    };

    function loadTextsAndComments() {
        const txtTransaction = db.transaction(['customTexts'], 'readonly');
        txtTransaction.objectStore('customTexts').getAll().onsuccess = (event) => {
            const texts = event.target.result;
            texts.forEach(item => { data.texts[item.id] = item.text; });

            const cmtTransaction = db.transaction(['comments'], 'readonly');
            cmtTransaction.objectStore('comments').getAll().onsuccess = (event) => {
                const comments = event.target.result;
                comments.forEach(item => { data.comments[item.id] = item.comment; });
                callback(data);
            };
        };
    }
}

function toggleTheme() {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    updateThemeIcon();
    if (editor) {
        editor.setTheme(isDark ? OverTypeDarkTheme : OverTypeLightTheme);
    }
}

function updateThemeIcon() {
    const isDark = document.body.classList.contains('dark-mode');
    const btn = document.getElementById('theme-toggle');
    if(btn) btn.innerHTML = isDark ? icons.themeDark : icons.themeLight;
}

function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
    } else if (savedTheme === 'light') {
        document.body.classList.remove('dark-mode');
    } else {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-mode');
        }
    }
    updateThemeIcon();
}

document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

let editor;

function initOvertype() {
    if (typeof OverType !== 'undefined' && document.getElementById('comment-editor')) {
        const currentPlaceholder = translations[currentLang].commentPlaceholder;
        const isDark = document.body.classList.contains('dark-mode');
        const instances = new OverType('#comment-editor', {
            theme: isDark ? OverTypeDarkTheme : OverTypeLightTheme,
            toolbar: true,
            toolbarButtons: [
                toolbarButtons.bold,
                toolbarButtons.italic,
                toolbarButtons.separator,
                toolbarButtons.link,
                toolbarButtons.quote,
                toolbarButtons.separator,
                toolbarButtons.h1,
                toolbarButtons.h2,
                toolbarButtons.h3,
                toolbarButtons.separator,
                toolbarButtons.bulletList,
                toolbarButtons.orderedList,
                toolbarButtons.separator,
                toolbarButtons.viewMode,
            ],
            placeholder: currentPlaceholder
        });
        editor = instances[0];
        const editorElement = document.getElementById('comment-editor');
        if (editorElement) {
            editorElement.addEventListener('input', () => {
                if (currentCommentIndex !== null && editor && typeof editor.getValue === 'function') {
                    const currentComment = editor.getValue();
                    saveComment(currentCommentIndex, currentComment);
                }
            });
        }
    }
}


function openFilenameModal(extension, callback) {
    const modal = document.getElementById('filename-modal');
    const overlay = document.getElementById('overlay');
    const input = document.getElementById('filename-input');
    const extSpan = document.getElementById('filename-extension');

    onFilenameConfirmed = callback;
    extSpan.innerText = extension;
    input.value = "";
    overlay.style.display = 'block';
    modal.style.display = 'block';

    requestAnimationFrame(() => {
        modal.classList.add('open');
    });
    
    input.focus();
}

document.getElementById('screenshot').addEventListener('click', () => {
    openFilenameModal('.jpg', (filename) => {
        generateScreenshot(filename);
    });
});

document.getElementById('download-btn').addEventListener('click', () => {
    openFilenameModal('.html', (filename) => {
        exportAsHTML(filename);
    });
});

document.getElementById('filename-save-btn').onclick = () => {
    const input = document.getElementById('filename-input');
    const rawName = input.value.trim();
    const filename = rawName.length > 0 ? rawName : 'my_game_meme';

    if (onFilenameConfirmed) {
        onFilenameConfirmed(filename);
    }
    
    closeAllModals();
};

document.getElementById('filename-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('filename-save-btn').click();
    }
});

async function showPanel(index, anchorBtn) {
    const lang = currentLang;
    const t = translations[lang];
    const modal = document.querySelector('.modal');
    const card = anchorBtn.closest('.card');
    const overlay = document.querySelector('.overlay');
    card.appendChild(modal);
    const textElement = card.querySelector('p');
    const title = textElement ? textElement.innerText : (t.phrases[index] || '');
    document.getElementById('modal-title').innerText = title;
    const closeHint = modal.querySelector('.close-hint');
    if (closeHint) {
        closeHint.innerText = (t.closeHint || (lang === 'ru' ? 'Нажмите вне окна или Esc, чтобы закрыть' : 'Click outside or press Esc to close'));
    }
    await new Promise((resolve) => {
        getComment(index, (comment) => {
            if (editor && typeof editor.setValue === 'function') {
                editor.setValue(comment || '');
                try { editor.focus(); } catch (e) {}
            } else {
                const ce = document.getElementById('comment-editor');
                if (ce) ce.innerText = comment || '';
            }
            resolve();
        });
    });

    overlay.style.display = 'block';
    modal.style.display = 'block';
    document.body.style.pointerEvents = 'none';
    modal.style.pointerEvents = 'auto';
    overlay.style.pointerEvents = 'auto';
    modal.style.visibility = 'hidden';
    await new Promise(resolve => requestAnimationFrame(() => {
        requestAnimationFrame(resolve);
    }));
    
    const cardRect = card.getBoundingClientRect();
    const modalRect = modal.getBoundingClientRect();
    const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
    const availableWidth = window.innerWidth - scrollbarWidth;
    const windowHeight = window.innerHeight;
    const margin = 12;
    const edgeMargin = 8;
    let modalTop = '100%';
    const spaceBelow = windowHeight - cardRect.bottom;
    const spaceAbove = cardRect.top;
    
    if (spaceBelow >= modalRect.height + margin) {
        modalTop = '100%';
        modal.style.bottom = 'auto';
    } else if (spaceAbove >= modalRect.height + margin) {
        modalTop = 'auto';
        modal.style.bottom = '100%';
    } else {
        if (spaceBelow >= spaceAbove) {
            modalTop = '100%';
            modal.style.bottom = 'auto';
        } else {
            modalTop = 'auto';
            modal.style.bottom = '100%';
        }
    }
    
    const idealCardRelativeLeft = (cardRect.width - modalRect.width) / 2;
    const viewportLeft = cardRect.left + idealCardRelativeLeft;
    const minViewportLeft = edgeMargin;
    const maxViewportLeft = availableWidth - modalRect.width - edgeMargin;
    const clampedViewportLeft = Math.max(minViewportLeft, Math.min(viewportLeft, maxViewportLeft));
    const cardRelativeLeft = clampedViewportLeft - cardRect.left;
    
    modal.style.position = 'absolute';
    modal.style.left = cardRelativeLeft + 'px';
    modal.style.top = modalTop;
    modal.style.visibility = 'visible';
    modal.style.transform = 'scale(0.95)';
    modal.classList.remove('open');
    void modal.offsetHeight;
    requestAnimationFrame(() => {
        modal.classList.add('open');
        modal.style.transform = 'scale(1)';
    });
}

function closeAllModals() {
    const modal = document.querySelector('.modal');
    const overlay = document.querySelector('.overlay');
    
    if (modal.parentElement && modal.parentElement !== document.body) {
        overlay.parentElement.insertBefore(modal, overlay.nextSibling);
    }
    
    document.body.style.pointerEvents = 'auto';
    modal.style.pointerEvents = 'auto';
    modal.classList.remove('open');
    setTimeout(() => {
        if (!modal.classList.contains('open')) {
            modal.style.display = 'none';
        }
    }, 160);

    const infoModal = document.getElementById('info-modal');
    if (infoModal) {
        infoModal.classList.remove('open');
        setTimeout(() => {
            if (!infoModal.classList.contains('open')) {
                infoModal.style.display = 'none';
            }
        }, 160);
    }

    filenameModal.classList.remove('open');
    setTimeout(() => {
        if (!filenameModal.classList.contains('open')) {
            filenameModal.style.display = 'none';
        }
    }, 160);

    document.getElementById('overlay').style.display = 'none';
    pendingExportType = null;
}

filenameSaveBtn.addEventListener('click', () => {
    const rawName = filenameInput.value.trim();
    const name = rawName.length > 0 ? rawName : null;

    if (pendingExportType === 'png') {
        generateScreenshot(name);
    } else if (pendingExportType === 'html') {
        exportAsHTML(name);
    }
    closeAllModals();
});

document.getElementById('filename-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        document.getElementById('filename-save-btn').click();
    }
});

function generateScreenshot(customName) {
    const elementToCapture = document.getElementById('capture-area');

    html2canvas(elementToCapture, {
        backgroundColor: "#ffffff",
        windowWidth: 1920,
        windowHeight: 1080,
        useCORS: true,
        scale: 1,
        onclone: (clonedDoc) => {
            clonedDoc.body.classList.remove('dark-mode');
            const clonedCommentBtns = clonedDoc.querySelectorAll('.comment-btn');
            clonedCommentBtns.forEach(btn => btn.style.display = 'none');
            const clonedControls = clonedDoc.querySelector('.controls');
            if(clonedControls) clonedControls.style.display = 'none';
            const themeBtn = clonedDoc.getElementById('theme-toggle');
            const langBtn = clonedDoc.getElementById('lang-toggle');
            if(themeBtn) themeBtn.style.display = 'none';
            if(langBtn) langBtn.style.display = 'none';
            const placeholders = clonedDoc.querySelectorAll('.image-placeholder');
            placeholders.forEach(ph => {
                if (!ph.style.backgroundImage || ph.style.backgroundImage === 'none' || ph.style.backgroundImage === '') {
                    ph.style.opacity = '0';
                }
            });
        }
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = customName ? `${customName}.jpg` : 'favorite_game_meme.jpg';
        link.href = canvas.toDataURL('image/jpeg');
        link.click();
    });
}

function exportAsHTML(customName) {
    getAllData((data) => {
        const escapeHtml = (text) => {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, m => map[m]);
        };

        const editedPhrases = [];
        const defaultPhrases = translations[currentLang].phrases;
        for (let i = 0; i < defaultPhrases.length; i++) {
            const key = currentLang + '_' + i;
            editedPhrases.push(data.texts[key] || defaultPhrases[i]);
        }

        if (typeof OverType !== 'undefined' && OverType.MarkdownParser) {
            for (let key in data.comments) {
                if (data.comments[key]) {
                    let html = OverType.MarkdownParser.parse(data.comments[key]);
                    html = html.replace(/<span class="syntax-marker[^"]*">.*?<\/span>/g, "");
                    html = html.replace(/\sclass="(bullet-list|ordered-list|code-fence|hr-marker|blockquote|url-part)"/g, "");
                    html = html.replace(/\sclass=""/g, "");
                    
                    data.comments[key] = html;
                }
            }
        }

        const scriptContent = `
var allComments = ${JSON.stringify(data.comments)};
var phrases = ${JSON.stringify(editedPhrases)};
var translations = {
  ru: {
    closeHint: 'Нажмите вне окна или Esc, чтобы закрыть',
    noComment: 'Комментарий отсутствует'
  },
  en: {
    closeHint: 'Click outside or press Esc to close',
    noComment: 'No comment'
  }
};
var currentLang = '${currentLang}';

function getComment(i) {
  return allComments[currentLang + '_comment_' + i] || '';
}

function showPanel(index, anchorBtn) {
  var title = phrases[index] || '';
  var panel = document.querySelector('.panel');
  document.getElementById('panel-title').innerText = title;
  document.querySelector('.close-hint').innerText = translations[currentLang].closeHint;
  
  var comment = getComment(index);
  var bodyEl = document.getElementById('panel-body');
  
  if (!comment) {
      bodyEl.innerText = translations[currentLang].noComment;
  } else {
      bodyEl.innerHTML = comment;
  }
  
  var card = anchorBtn.closest('.card');
  var rect = card.getBoundingClientRect();
  
  
  var fixedSpace = 40;
  var panelBodyHeight = rect.height - fixedSpace;

  bodyEl.style.maxHeight = panelBodyHeight + 'px';
  bodyEl.style.overflowY = 'auto';

  panel.style.overflowY = 'hidden';

  var desiredWidth = rect.width * 2;
  var maxAllowed = Math.min(window.innerWidth - 16, 640);
  var panelWidth = Math.max(160, Math.min(desiredWidth, maxAllowed));
  panel.style.width = panelWidth + 'px';
  
  var overlay = document.querySelector('.overlay');
  overlay.style.display = 'block';
  
  panel.style.display = 'block';
  panel.style.visibility = 'hidden';
  var panelHeight = panel.offsetHeight;
  
  var spaceBelow = window.innerHeight - rect.bottom;
  var spaceAbove = rect.top;
  var margin = 12;
  var top, isAbove;
  if (spaceBelow >= panelHeight + margin) {
    top = rect.bottom + margin;
    isAbove = false;
  } else if (spaceAbove >= panelHeight + margin) {
    top = rect.top - panelHeight - margin;
    isAbove = true;
  } else {
    top = Math.min(rect.bottom + margin, window.innerHeight - panelHeight - margin);
    if (top < margin) top = margin;
    isAbove = (rect.top - top) > (top + panelHeight - rect.bottom);
  }
  
  var cardCenter = rect.left + rect.width / 2;
  var left = cardCenter - panelWidth / 2;
  var minLeft = 8;
  var maxLeft = window.innerWidth - panelWidth - 50;
  if (left < minLeft) left = minLeft;
  if (left > maxLeft) left = maxLeft;
  
  panel.style.left = left + 'px';
  panel.style.top = top + 'px';
  panel.style.visibility = 'visible';
  panel.classList.add('open');
}

function closePanel() {
  var panel = document.querySelector('.panel');
  var overlay = document.querySelector('.overlay');
  panel.classList.remove('open');
  panel.style.display = 'none';
  overlay.style.display = 'none';
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
  var btn = document.getElementById('theme-toggle');
  var isDark = document.body.classList.contains('dark-mode');
  btn.innerHTML = isDark ? '${icons.themeDark}' : '${icons.themeLight}';
}

document.addEventListener('DOMContentLoaded', function() {
  var overlay = document.querySelector('.overlay');
  if (overlay) overlay.onclick = closePanel;
  
  var btns = document.querySelectorAll('.explain-btn');
  for (var i = 0; i < btns.length; i++) {
    (function(btn) {
      btn.onclick = function(e) {
        showPanel(parseInt(btn.getAttribute('data-index')), btn);
      };
    })(btns[i]);
  }
  
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closePanel();
  });
});
`;

        const lines = [];
        lines.push('<!DOCTYPE html>');
        lines.push('<html lang="' + currentLang + '">');
        lines.push('<head>');
        lines.push('<meta charset="UTF-8">');
        lines.push('<meta name="viewport" content="width=device-width, initial-scale=1.0">');

        const defaultTitles = {
            ru: 'Ультимативный "Любимая игра meme"',
            en: 'The Ultimate "Favorite Game Meme"'
        };
        const pageTitle = customName ? customName : (defaultTitles[currentLang] || 'The Ultimate "Favorite Game Meme"');
        lines.push('<title>' + escapeHtml(pageTitle) + '</title>');
        lines.push('<style>');
        lines.push(':root{--bg-color:#ffffff;--text-color:#202020;--border:#ccc;--btn-bg:#ddd;--link-color:#0000ed;--btn-hover:#e0e0e0;}');
        lines.push('body.dark-mode{--bg-color:#121212;--text-color:#e0e0e0;--border:#444;--btn-bg:#2a2a2a;--link-color:#1e90ff;--btn-hover:#4d4d4d;--btn-bg:#2a2a2a;}');
        lines.push('body{font-family:Arial,sans-serif;margin:20px;position:relative;background:var(--bg-color);color:var(--text-color);}');
        lines.push('.card{border:1px solid var(--border);padding:3px;text-align:center;background:var(--bg-color);display:flex;flex-direction:column}');
        lines.push('button svg{width:20px;height:20px;fill:var(--text-color)}');
        lines.push('.explain-btn{width:100%;padding:8px;background:var(--btn-bg);border:1px solid var(--border);color:var(--text-color);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:auto}');
        lines.push('.close-hint{font-size:12px;color:#666;margin-top:8px}');
        lines.push('.image{min-height:100px;aspect-ratio:264/352;background-color:var(--btn-bg);margin-bottom:8px;background-position:center;background-repeat:no-repeat;background-size:cover}');
        lines.push('.panel{background:var(--bg-color);border:1px solid var(--border);color:var(--text-color);position:fixed;display:none;left:0;top:0;width:auto;max-width:640px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.18);padding:12px;z-index:210;opacity:0;transform:scale(0.95);transition:opacity 160ms ease-in-out, transform 160ms ease-in-out;overflow:visible; box-sizing: border-box; overflow:hidden;}');
        lines.push('#theme-toggle{position:absolute;top:10px;right:10px;z-index:100;padding: 8px 12px;margin:0;background:var(--btn-bg);color:var(--text-color);border:1px solid var(--border);border-radius:4px;}');
        lines.push('h1, p {color:var(--text-color)}');
        lines.push('a {color:var(--link-color)}');
        lines.push('.main-title{text-align:center}.grid{display:grid;grid-template-columns:repeat(10,minmax(100px,1fr));gap:0}.phrase{margin:0 0 6px 0;font-weight:normal}.overlay{position:fixed;inset:0;background:transparent;display:none;z-index:200}.panel.open{display:block;opacity:1;transform:scale(1)}.panel h3{margin:0 0 8px 0;font-size:15px}');
        lines.push('.body{font-size:14px;line-height:1.4;word-wrap:break-word;} .body strong{font-weight:bold;color:var(--text-color);} .body em{font-style:italic;} .body ul, .body ol{margin:8px 0;padding-left:20px;}');
        lines.push('</style>');
        lines.push('<script>');
        lines.push(scriptContent);
        lines.push('<\/script>');
        lines.push('</head>');
        lines.push('<body>');

        const h1Texts = {
            ru: 'УЛЬТИМАТИВНЫЙ "ЛЮБИМАЯ ИГРА MEME"',
            en: 'THE ULTIMATE "FAVORITE GAME MEME"'
        };
        lines.push('<h1 class="main-title">' + (h1Texts[currentLang] || 'THE ULTIMATE "FAVORITE GAME MEME"') + '</h1>');
        lines.push('<div class="grid">');
        lines.push('<button id="theme-toggle" onclick="toggleTheme()">' + icons.themeLight + '</button>');

        const t = translations[currentLang];
        t.phrases.forEach((phrase, index) => {
            const imageData = data.images[index] || '';
            const bgStyle = imageData ? 'background-image:url(' + imageData + ')' : '';
            const textData = escapeHtml(data.texts[currentLang + '_' + index] || phrase);
            const btnLabel = currentLang === 'ru' ? 'Комментарий' : 'Comment';

            const commentKey = currentLang + '_comment_' + index;
            const hasComment = data.comments[commentKey] && data.comments[commentKey].length > 0;
            const disabledState = hasComment ? '' : 'disabled style="opacity:0.5; cursor:default;"';

            const cardHtml = '<div class="card">' +
                '<div class="image" style="' + bgStyle + '"></div>' +
                '<p class="phrase">' + textData + '</p>' +
                '<button class="explain-btn" data-index="' + index + '" ' + disabledState + '>' +
                '<span style="font-size:16px"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#000000"><path d="M240-400h480v-80H240v80Zm0-120h480v-80H240v80Zm0-120h480v-80H240v80ZM880-80 720-240H160q-33 0-56.5-23.5T80-320v-480q0-33 23.5-56.5T160-880h640q33 0 56.5 23.5T880-800v720ZM160-320h594l46 45v-525H160v480Zm0 0v-480 480Z"/></svg></span>' +
                '<span style="font-size:16px">' + btnLabel + '</span>' +
                '</button>' +
                '</div>';
            lines.push(cardHtml);
        });

        lines.push('</div>');
        const footerText = currentLang === 'ru' ? 'Создано с помощью' : 'Created with';
        const siteUrl = window.location.origin + window.location.pathname;
        lines.push('<div style="text-align: center; margin: 10px auto 0 auto; width: 100%;">');
        lines.push('<a href="' + siteUrl + '" target="_blank" style="font-size: 13px; color: #555; text-decoration: underline; cursor: pointer; font-family: Arial, sans-serif;">');
        lines.push(footerText + ' Ultimate Game Meme');
        lines.push('</a>');
        lines.push('</div>');
        lines.push('<div class="overlay" id="overlay" aria-hidden="true"></div>');
        lines.push('<div class="panel" id="panel" role="dialog" aria-modal="true">');
        lines.push('<h3 id="panel-title">Заголовок</h3>');
        lines.push('<div id="panel-body" class="body">Пояснение...</div>');
        const closeHintText = currentLang === 'ru' ? 'Нажмите вне окна или Esc, чтобы закрыть' : 'Click outside or press Esc to close';
        lines.push('<div class="close-hint">' + closeHintText + '</div>');
        lines.push('</ div>');
        lines.push('</ body>');
        lines.push('</ html>');

        const html = lines.join('\n');
        const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        const filename = customName ? `${customName}.html` : ('ultimate_game_meme_' + new Date().toISOString().split('T')[0] + '.html');
        link.download = filename;
        link.click();
        URL.revokeObjectURL(url);
    });
}

document.getElementById('clear').addEventListener('click', () => {
    if (confirm(translations[currentLang].clearConfirm)) {
        if (!db) return;

        const imgTransaction = db.transaction(['images'], 'readwrite');
        imgTransaction.objectStore('images').clear();

        const txtTransaction = db.transaction(['customTexts'], 'readwrite');
        txtTransaction.objectStore('customTexts').clear();

        const cmtTransaction = db.transaction(['comments'], 'readwrite');
        const cmtRequest = cmtTransaction.objectStore('comments').clear();

        cmtRequest.onsuccess = () => {
            location.reload();
        };
    }
});

document.getElementById('lang-toggle').addEventListener('click', () => {
    currentLang = (currentLang === 'ru') ? 'en' : 'ru';
    localStorage.setItem('preferredLang', currentLang);
    updateUI(currentLang);
    loadTexts();
    loadComments();
    closeAllModals();
});

document.getElementById('comment-toggle').addEventListener('change', () => {
    const isEnabled = document.getElementById('comment-toggle').checked;
    const downloadBtn = document.getElementById('download-btn');
    const commentBtns = document.querySelectorAll('.comment-btn');
    const infoLink = document.querySelector('.info-link-container');
    localStorage.setItem('commentsEnabled', isEnabled);

    if (isEnabled) {
        downloadBtn.style.display = 'inline-flex';
        commentBtns.forEach(btn => btn.style.display = 'flex');
        if (infoLink) infoLink.style.display = 'block';

        window.scrollTo({
            top: document.body.scrollHeight,
        });
    } else {
        downloadBtn.style.display = 'none';
        commentBtns.forEach(btn => btn.style.display = 'none');
        if (infoLink) infoLink.style.display = 'none';
    }
});

document.getElementById('overlay').addEventListener('click', () => {
    closeAllModals();
});

document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeAllModals();
});

const infoModalElement = document.getElementById('info-modal');
const overlay = document.getElementById('overlay');

document.getElementById('info-trigger').addEventListener('click', () => {
    overlay.style.display = 'block';
    infoModalElement.style.display = 'block';
    requestAnimationFrame(() => {
        infoModalElement.classList.add('open');
    });
});

document.getElementById('info-modal-close').addEventListener('click', () => {
    infoModalElement.classList.remove('open');
    setTimeout(() => {
        if (!infoModalElement.classList.contains('open')) {
            infoModalElement.style.display = 'none';
            overlay.style.display = 'none';
        }
    }, 160);
});

overlay.addEventListener('click', () => {
    infoModalElement.classList.remove('open');
    setTimeout(() => {
        if (!infoModalElement.classList.contains('open')) {
            infoModalElement.style.display = 'none';
        }
    }, 160);
    closeAllModals();
});

function getInitialLang() {
    const savedLang = localStorage.getItem('preferredLang');
    if (savedLang && translations[savedLang]) {
        return savedLang;
    }
    const browserLang = navigator.language.split('-')[0];
    return (browserLang === 'ru') ? 'ru' : 'en';
}

function getCommentsEnabled() {
    const savedToggleState = localStorage.getItem('commentsEnabled');
    if (savedToggleState === 'true') {
        document.getElementById('comment-toggle').checked = true;
    } else {
        document.getElementById('comment-toggle').checked = false;
    }
}

window.addEventListener('load', () => {
    currentLang = getInitialLang();
    getCommentsEnabled();
    initTheme();
    initOvertype();
    updateUI(currentLang);
    initDB(() => {
        loadImages();
        loadTexts();
        loadComments();
    });
});